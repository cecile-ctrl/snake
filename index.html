<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Snake in Real Life</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }

    #startScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      flex-direction: column;
      color: white;
    }

    #startScreen h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }

    #startBtn {
      padding: 12px 24px;
      font-size: 18px;
      background: #fff;
      color: #2E7D32;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    #startBtn:hover {
      background: #f0f0f0;
    }

    #map { 
      height: 100vh; 
      display: none; /* verborgen tot start */
    }

    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-size: 16px;
      font-weight: bold;
      display: none; /* verborgen tot start */
    }
  </style>
</head>
<body>
  <!-- Startscherm -->
  <div id="startScreen">
    <h1>Snake in Real Life</h1>
    <button id="startBtn">Start spel</button>
  </div>

  <!-- Spel -->
  <div id="map"></div>
  <div id="score">Score: 0</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, pathCoords = [], pathLine = null, foodMarker = null, foodCoords = null;
    let roads = [], center = null, score = 0, maxPathLength = 500;
    const stepTime = 5000;

    // ---- Score bijwerken ----
    function updateScore() {
      document.getElementById("score").innerText = "Score: " + score;
    }

    // ---- OSM wegen laden ----
    async function loadRoads(center, radius=2000) {
      const query = `
        [out:json];
        way["highway"]["highway"!="motorway"]["highway"!="trunk"]
          (around:${radius},${center[0]},${center[1]});
        out geom;
      `;
      const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      const res = await fetch(url);
      const data = await res.json();
      roads = data.elements;
    }

    function randomPointOnRoad() {
      if (roads.length === 0) return null;
      const road = roads[Math.floor(Math.random() * roads.length)];
      const nodes = road.geometry;
      if (nodes.length < 2) return null;
      const idx = Math.floor(Math.random() * (nodes.length - 1));
      const a = nodes[idx], b = nodes[idx+1];
      const t = Math.random();
      return [
        a.lat + t * (b.lat - a.lat),
        a.lon + t * (b.lon - a.lon)
      ];
    }

    function generateFood() {
      const point = randomPointOnRoad();
      if (!point) return;

      if (foodMarker) map.removeLayer(foodMarker);

      const appleIcon = L.divIcon({
        html: "ðŸŽ",
        className: "",
        iconSize: [24, 24]
      });

      foodMarker = L.marker(point, { icon: appleIcon }).addTo(map);
      foodCoords = point;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
      const Î”Ï† = (lat2-lat1) * Math.PI/180;
      const Î”Î» = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Î”Ï†/2)**2 +
                Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function getPathLength(coords) {
      let length = 0;
      for (let i = 1; i < coords.length; i++) {
        length += getDistance(
          coords[i-1][0], coords[i-1][1],
          coords[i][0], coords[i][1]
        );
      }
      return length;
    }

    function trimPath() {
      let length = getPathLength(pathCoords);
      while (length > maxPathLength && pathCoords.length > 1) {
        pathCoords.shift();
        length = getPathLength(pathCoords);
      }
    }

    function intersectsPath(newPoint) {
      if (pathCoords.length < 2) return false;
      for (let i = 0; i < pathCoords.length - 2; i++) {
        if (pathCoords[i][0] === newPoint[0] && pathCoords[i][1] === newPoint[1]) {
          return true;
        }
      }
      return false;
    }

    function trackLocation() {
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        const newPoint = [latitude, longitude];

        if (!center) {
          center = newPoint;
          await loadRoads(center, 2000);
          generateFood();
        }

        if (!intersectsPath(newPoint)) {
          pathCoords.push(newPoint);
          trimPath();

          if (pathLine) map.removeLayer(pathLine);
          pathLine = L.polyline(pathCoords, { color: 'green' }).addTo(map);
          map.setView(newPoint, 17);

          if (foodCoords) {
            const d = getDistance(latitude, longitude, foodCoords[0], foodCoords[1]);
            if (d < 20) { // appel gepakt
              score++;
              updateScore();
              maxPathLength += 500;
              generateFood();
            }
          }
        } else {
          alert("Game Over! Je hebt je eigen pad geraakt.");
        }
      });
    }

    // ---- Startknop functionaliteit ----
    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("map").style.display = "block";
      document.getElementById("score").style.display = "block";

      // init map pas bij start
      map = L.map('map').setView([52.3702, 4.8952], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);

      // locatie bijhouden starten
      setInterval(trackLocation, stepTime);
    });
  </script>
</body>
</html>
