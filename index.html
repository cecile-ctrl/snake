<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Snake in Real Life</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }

    #startScreen, #gameOverScreen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      flex-direction: column;
      color: white;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 999;
    }

    #startScreen h1, #gameOverScreen h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 18px;
      background: #fff;
      color: #2E7D32;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    button:hover {
      background: #f0f0f0;
    }

    #map { height: 100vh; display: none; }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-size: 16px;
      font-weight: bold;
      display: none;
      z-index: 500;
    }

    /* ðŸ”µ Blauwe pin zoals in Google Maps */
    .blue-pin {
      width: 24px;
      height: 24px;
      border-radius: 50% 50% 50% 0;
      background: #4285F4;
      position: absolute;
      transform: rotate(-45deg);
      left: 50%;
      top: 50%;
      margin: -12px 0 0 -12px;
      border: 2px solid white;
    }
    .blue-pin::after {
      content: "";
      width: 8px;
      height: 8px;
      margin: 7px 0 0 7px;
      background: white;
      position: absolute;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- Startscherm -->
  <div id="startScreen">
    <h1>Snake in Real Life</h1>
    <button id="startBtn">Start spel</button>
  </div>

  <!-- Game Over scherm -->
  <div id="gameOverScreen" style="display:none;">
    <h1>Game Over!</h1>
    <p id="finalScore">Score: 0</p>
    <button id="restartBtn">Opnieuw starten</button>
  </div>

  <!-- Spel -->
  <div id="map"></div>
  <div id="score">Score: 0</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map, pathCoords, pathLine, foodMarker, foodCoords, roads, center, score, maxPathLength;
    let playerMarker = null;
    let playerCircle = null;
    const stepTime = 5000;
    let gameInterval = null;

    function resetGame() {
      pathCoords = [];
      pathLine = null;
      foodMarker = null;
      foodCoords = null;
      roads = [];
      center = null;
      score = 0;
      maxPathLength = 500;
      updateScore();
    }

    // ---- Score bijwerken ----
    function updateScore() {
      document.getElementById("score").innerText = "Score: " + score;
    }

    // ---- Wegen laden ----
    async function loadRoads(center, radius=2000) {
      const query = `
        [out:json];
        way["highway"]["highway"!="motorway"]["highway"!="trunk"]
          (around:${radius},${center[0]},${center[1]});
        out geom;
      `;
      const url = "https://overpass.kumi.systems/api/interpreter?data=" + encodeURIComponent(query);
      try {
        const res = await fetch(url);
        const data = await res.json();
        roads = data.elements;
      } catch (err) {
        console.warn("Kon geen wegen laden:", err);
        roads = [];
      }
    }

    function randomPointOnRoad() {
      if (roads.length === 0) return null;
      const road = roads[Math.floor(Math.random() * roads.length)];
      const nodes = road.geometry;
      if (nodes.length < 2) return null;
      const idx = Math.floor(Math.random() * (nodes.length - 1));
      const a = nodes[idx], b = nodes[idx+1];
      const t = Math.random();
      return [a.lat + t * (b.lat - a.lat), a.lon + t * (b.lon - a.lon)];
    }

    function randomPointFallback() {
      if (!center) return null;
      const lat = center[0] + (Math.random() - 0.5) * 0.018;
      const lon = center[1] + (Math.random() - 0.5) * 0.028;
      return [lat, lon];
    }

    function generateFood() {
      let point = randomPointOnRoad();
      if (!point) point = randomPointFallback();
      if (!point) return;

      if (foodMarker) map.removeLayer(foodMarker);

      const appleIcon = L.divIcon({ html: "ðŸŽ", className: "", iconSize: [24, 24] });
      foodMarker = L.marker(point, { icon: appleIcon }).addTo(map);
      foodCoords = point;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
      const Î”Ï† = (lat2-lat1) * Math.PI/180;
      const Î”Î» = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function getPathLength(coords) {
      let length = 0;
      for (let i = 1; i < coords.length; i++) {
        length += getDistance(coords[i-1][0], coords[i-1][1], coords[i][0], coords[i][1]);
      }
      return length;
    }

    function trimPath() {
      let length = getPathLength(pathCoords);
      while (length > maxPathLength && pathCoords.length > 1) {
        pathCoords.shift();
        length = getPathLength(pathCoords);
      }
    }

    function intersectsPath(newPoint) {
      if (pathCoords.length < 2) return false;
      for (let i = 0; i < pathCoords.length - 2; i++) {
        if (pathCoords[i][0] === newPoint[0] && pathCoords[i][1] === newPoint[1]) {
          return true;
        }
      }
      return false;
    }

    function gameOver() {
      clearInterval(gameInterval);
      document.getElementById("finalScore").innerText = "Score: " + score;
      document.getElementById("gameOverScreen").style.display = "flex";
    }

    function trackLocation() {
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        const newPoint = [latitude, longitude];

        if (!center) {
          center = newPoint;
          await loadRoads(center, 2000);
          generateFood();
        }

        // ---- Eigen locatie marker (blauwe pin + cirkel nauwkeurigheid) ----
        if (playerMarker) map.removeLayer(playerMarker);
        if (playerCircle) map.removeLayer(playerCircle);

        const bluePinIcon = L.divIcon({ className: "blue-pin", iconSize: [24, 24] });
        playerMarker = L.marker(newPoint, { icon: bluePinIcon }).addTo(map);
        playerCircle = L.circle(newPoint, { radius: accuracy, color: "blue", opacity: 0.3 }).addTo(map);

        // ---- Pad tekenen ----
        if (!intersectsPath(newPoint)) {
          pathCoords.push(newPoint);
          trimPath();

          if (pathLine) map.removeLayer(pathLine);
          pathLine = L.polyline(pathCoords, { color: 'green' }).addTo(map);
          map.setView(newPoint, 17);

          if (foodCoords) {
            const d = getDistance(latitude, longitude, foodCoords[0], foodCoords[1]);
            if (d < 20) {
              score++;
              updateScore();
              maxPathLength += 500;
              generateFood();
            }
          }
        } else {
          gameOver();
        }
      }, err => {
        console.error("GPS fout:", err);
      });
    }

    // ---- Startknop ----
    document.getElementById("startBtn").addEventListener("click", () => {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("map").style.display = "block";
      document.getElementById("score").style.display = "block";

      map = L.map('map').setView([52.3702, 4.8952], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      resetGame();
      gameInterval = setInterval(trackLocation, stepTime);
    });

    // ---- Restartknop ----
    document.getElementById("restartBtn").addEventListener("click", () => {
      document.getElementById("gameOverScreen").style.display = "none";
      resetGame();
      if (map) {
        map.eachLayer(layer => { 
          if (layer instanceof L.Polyline || layer instanceof L.Marker || layer instanceof L.Circle) map.removeLayer(layer); 
        });
      }
      gameInterval = setInterval(trackLocation, stepTime);
    });
  </script>
</body>
</html>

